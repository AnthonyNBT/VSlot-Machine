<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X·ªï S·ªë May M·∫Øn - C√≥ √Çm Thanh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&family=Be+Vietnam+Pro:wght@400;600;900&display=swap');

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background: radial-gradient(circle at center, #111827 0%, #000000 100%);
        }

        .mono-font {
            font-family: 'Roboto Mono', monospace;
        }

        .slot-machine-container {
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.8);
            background: linear-gradient(145deg, #1f2937, #0f131a);
            border: 2px solid #374151;
            transition: all 0.3s ease;
        }

        .winner-glow {
            animation: glow 1.5s ease-in-out infinite alternate;
            border-color: #fbbf24;
            box-shadow: 0 0 80px rgba(251, 191, 36, 0.5);
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
            }

            to {
                box-shadow: 0 0 60px rgba(251, 191, 36, 0.7), 0 0 20px rgba(251, 191, 36, 0.3);
            }
        }

        .btn-3d {
            transition: all 0.1s;
            box-shadow: 0px 5px 0px 0px #7f1d1d;
        }

        .btn-3d:active {
            transform: translateY(5px);
            box-shadow: 0px 0px 0px 0px #7f1d1d;
        }

        .btn-3d:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(5px);
            box-shadow: none;
        }

        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        /* Modal & Scrollbar */
        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .sound-wave {
            display: inline-flex;
            align-items: center;
            height: 20px;
            gap: 2px;
        }

        .bar {
            width: 3px;
            background-color: #fbbf24;
            animation: wave 1s ease-in-out infinite;
        }

        .bar:nth-child(2) {
            animation-delay: 0.1s;
            height: 10px;
        }

        .bar:nth-child(3) {
            animation-delay: 0.2s;
            height: 15px;
        }

        .bar:nth-child(4) {
            animation-delay: 0.3s;
            height: 8px;
        }

        @keyframes wave {

            0%,
            100% {
                transform: scaleY(1);
            }

            50% {
                transform: scaleY(1.5);
            }
        }

        .slot-machine-container {
            height: calc(100dvh - 350px);
        }
    </style>
</head>

<body class="text-white min-h-screen flex flex-col items-center p-4 overflow-hidden relative">

    <canvas id="confetti-canvas"></canvas>

    <!-- Header & Settings -->
    <header class="w-full max-w-6xl flex justify-between items-center mb-12 mt-10 relative z-20 px-4" style="height: 50px;">
        <!-- Sound Toggle -->
        <button id="btn-sound" onclick="toggleSound()"
            class="control-view flex items-center gap-2 bg-gray-800 hover:bg-gray-700 py-2 px-4 rounded-full border border-gray-600 transition-colors text-sm font-bold text-gray-300">
            <span id="sound-icon">üîä</span>
            <span id="sound-text">B·∫≠t Ti·∫øng</span>
        </button>

        <div class="text-center absolute left-1/2 transform -translate-x-1/2 w-full pointer-events-none">
            <h1
                class="leading-loose text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-red-500 to-yellow-400 uppercase tracking-wider drop-shadow-lg pointer-events-auto inline-block">
                V√≤ng Quay May M·∫Øn
            </h1>
        </div>

        <!-- Settings Button -->
        <button onclick="toggleModal()"
            class="control-view bg-gray-800 hover:bg-gray-700 p-3 rounded-full border border-gray-600 transition-colors"
            title="C·∫•u h√¨nh Google Sheet">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </header>

    <!-- Main Game Area -->
    <div class="relative z-10 w-full grid grid-cols-1 grid-cols-3 gap-8 mt-4">

        <!-- Left: Slot Machine -->
        <div id="slot-machine-main" class="col-span-2 flex flex-col items-center">
            <div id="slot-box"
                class="slot-machine-container rounded-3xl p-8 w-full flex flex-col items-center justify-center relative overflow-hidden mb-8 border-4 border-gray-700">
                <!-- Decorative Elements -->
                <div
                    class="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')] opacity-20">
                </div>

                <div class="absolute top-4 left-4 w-2 h-2 rounded-full bg-red-500 animate-pulse" onclick="hideControlView()"></div>
                <div class="absolute top-4 right-4 w-2 h-2 rounded-full bg-red-500 animate-pulse" onclick="showControlView()"></div>
                <div class="absolute bottom-4 left-4 w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                <div class="absolute bottom-4 right-4 w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>

                <!-- Display Area -->
                <div class="text-center w-full z-10">
                    <div
                        class="text-gray-500 text-xs md:text-sm uppercase tracking-[0.3em] mb-6 font-bold flex justify-center items-center gap-2">
                        <span class="w-8 h-[1px] bg-gray-600"></span> M√É S·ªê MAY M·∫ÆN <span
                            class="w-8 h-[1px] bg-gray-600"></span>
                    </div>

                    <div id="display-code"
                        class="mono-font text-6xl md:text-8xl font-black text-white tracking-widest transition-all min-h-[100px] flex items-center justify-center filter drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
                        -----
                    </div>

                    <div class="mt-6 h-20 flex flex-col justify-center">
                        <div id="display-name"
                            class="text-2xl md:text-4xl text-yellow-400 font-bold opacity-0 transition-opacity duration-300 truncate px-4 drop-shadow-md">
                            <!-- T√™n nh√¢n vi√™n -->
                        </div>
                        <div id="display-dept"
                            class="text-gray-400 text-sm md:text-base font-medium opacity-0 transition-opacity duration-300 mt-1">
                            <!-- Ph√≤ng ban -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col items-center gap-4 w-full">
                <div class="flex gap-4 w-full justify-center max-w-md">
                    <button id="btn-spin" onclick="startSpin()"
                        class="btn-3d bg-gradient-to-b from-red-500 to-red-700 hover:from-red-400 hover:to-red-600 text-white font-bold py-5 px-10 rounded-2xl text-2xl uppercase tracking-wider flex-grow disabled:filter disabled:grayscale shadow-lg transform transition-transform">
                        QUAY S·ªê
                    </button>

                    <button onclick="resetData()"
                        class="control-view bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-2xl transition-colors border-2 border-gray-600 flex items-center justify-center shadow-lg"
                        title="Reset danh s√°ch">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-300" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>

                <div
                    class="control-view text-gray-500 text-sm bg-gray-900/80 py-2 px-6 rounded-full border border-gray-700 backdrop-blur-sm">
                    Trong danh s√°ch: <span id="count-remaining" class="text-white font-bold text-lg mx-1">0</span> nh√¢n
                    vi√™n
                </div>
            </div>
        </div>

        <!-- Right: Winners History -->
        <div
            class="control-view bg-gray-800/40 backdrop-blur-xl rounded-2xl border border-gray-700 p-6 flex flex-col h-[500px] shadow-2xl relative overflow-hidden">
            <div
                class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent opacity-50">
            </div>

            <h2 class="text-xl font-bold text-yellow-400 mb-6 flex items-center gap-3">
                <div class="bg-yellow-400/10 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                </div>
                L·ªãch S·ª≠ Tr√∫ng Th∆∞·ªüng
            </h2>
            <div id="winners-list" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                <div class="text-gray-500 text-center italic mt-20 flex flex-col items-center opacity-50">
                    <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Ch∆∞a c√≥ ai tr√∫ng th∆∞·ªüng</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Settings -->
    <div id="modal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black/80 backdrop-blur-sm" onclick="toggleModal()"></div>

        <div class="modal-container bg-gray-800 w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto border border-gray-600 transform scale-95 transition-transform duration-300"
            id="modal-content">
            <div class="modal-content py-6 text-left px-8">
                <div class="flex justify-between items-center pb-4 border-b border-gray-700 mb-4">
                    <p class="text-2xl font-bold text-white">Ngu·ªìn D·ªØ Li·ªáu</p>
                    <div class="modal-close cursor-pointer z-50 hover:bg-gray-700 p-2 rounded-full transition-colors"
                        onclick="toggleModal()">
                        <svg class="fill-current text-gray-300" xmlns="http://www.w3.org/2000/svg" width="20"
                            height="20" viewBox="0 0 18 18">
                            <path
                                d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z">
                            </path>
                        </svg>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <p class="text-gray-300 text-sm mb-2 font-semibold">H∆∞·ªõng d·∫´n nhanh:</p>
                        <ol class="list-decimal list-inside text-xs text-gray-400 space-y-1 ml-1">
                            <li>Google Sheet: <strong>M√£ NV | T√™n NV | Ph√≤ng ban | Ch·ª©c danh</strong></li>
                            <li>V√†o <strong>T·ªáp > Chia s·∫ª > C√¥ng b·ªë l√™n web</strong></li>
                            <li>Ch·ªçn ƒë·ªãnh d·∫°ng <strong>.CSV</strong> ho·∫∑c <strong>ExportType</strong> r·ªìi copy link</li>
                        </ol>
                    </div>

                    <input type="text" id="sheet-url" placeholder="D√°n link CSV c·ªßa Google Sheet v√†o ƒë√¢y..."
                        class="w-full p-4 bg-gray-900 border border-gray-600 rounded-xl text-white focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 text-sm transition-all"
                        value="https://docs.google.com/spreadsheets/d/1CNZGvOW9akFPnBEp2tpLfeigvyf03VXckpRXiVcLNEk/export?format=csv">

                    <div id="status-area" class="min-h-[20px]">
                        <p id="loading-msg" class="text-yellow-400 text-sm hidden flex items-center gap-2">
                            <svg class="animate-spin h-4 w-4 text-yellow-400" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            ƒêang t·∫£i d·ªØ li·ªáu...
                        </p>
                        <p id="error-msg" class="text-red-400 text-sm hidden"></p>
                    </div>
                </div>

                <div class="flex justify-end pt-6 gap-3">
                    <button onclick="useSampleData()"
                        class="px-4 py-2 text-gray-400 hover:text-white text-sm font-medium transition-colors">D√πng m·∫´u
                        th·ª≠</button>
                    <button onclick="saveAndLoadSheet()"
                        class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-lg hover:from-blue-500 hover:to-blue-400 font-bold shadow-lg transform active:scale-95 transition-all">L∆∞u
                        & T·∫£i D·ªØ Li·ªáu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const AudioEngine = {
            ctx: null,
            enabled: true, // Default ON

            init: function () {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                // Resume if suspended (browser policy)
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },

            // Sound 1: Mechanical Tick (Ti·∫øng l·∫°ch c·∫°ch khi quay)
            playTick: function () {
                if (!this.enabled || !this.ctx) return;

                const osc = this.ctx.createOscillator();
                const gainNode = this.ctx.createGain();

                osc.connect(gainNode);
                gainNode.connect(this.ctx.destination);

                // High pitch short blip
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.05);

                gainNode.gain.setValueAtTime(0.3, this.ctx.currentTime); // Volume th·∫•p th√¥i
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.05);

                osc.start();
                osc.stop(this.ctx.currentTime + 0.05);
            },

            // Sound 2: Winner Sound (Ti·∫øng chu√¥ng th·∫Øng cu·ªôc)
            playWin: function () {
                if (!this.enabled || !this.ctx) return;

                const now = this.ctx.currentTime;

                // T·∫°o h·ª£p √¢m C Major (ƒê√¥ tr∆∞·ªüng) arpeggio
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6

                notes.forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();

                    osc.connect(gain);
                    gain.connect(this.ctx.destination);

                    osc.type = 'sine';
                    osc.frequency.value = freq;

                    const startTime = now + (i * 0.1);

                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(0.4, startTime + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.5);

                    osc.start(startTime);
                    osc.stop(startTime + 1.5);
                });
            }
        };

        function toggleSound() {
            AudioEngine.enabled = !AudioEngine.enabled;
            const btn = document.getElementById('sound-text');
            const icon = document.getElementById('sound-icon');
            const btnEl = document.getElementById('btn-sound');

            if (AudioEngine.enabled) {
                btn.innerText = "B·∫≠t Ti·∫øng";
                icon.innerText = "üîä";
                btnEl.classList.remove('opacity-50');
                // Try init immediately
                AudioEngine.init();
            } else {
                btn.innerText = "T·∫Øt Ti·∫øng";
                icon.innerText = "üîá";
                btnEl.classList.add('opacity-50');
            }
        }

        // --- DATA & GAME LOGIC ---
        const sampleEmployees = [
            { id: "DEV-01", name: "Nguy·ªÖn VƒÉn Code", dept: "Ph√≤ng K·ªπ Thu·∫≠t" },
            { id: "DHR-02", name: "Tr·∫ßn Th·ªã Tuy·ªÉn", dept: "Ph√≤ng Nh√¢n S·ª±" },
            { id: "SALE-03", name: "L√™ VƒÉn Ch·ªët", dept: "Ph√≤ng Kinh Doanh" },
            { id: "ACC-04", name: "Ph·∫°m Th·ªã Ti·ªÅn", dept: "Ph√≤ng K·∫ø To√°n" },
            { id: "MKT-05", name: "Ho√†ng ƒê·ª©c Viral", dept: "Ph√≤ng Marketing" }
        ];

        let employees = [];
        let originalEmployees = [];
        let isSpinning = false;
        let spinInterval;

        window.onload = function () {
            const savedUrl = localStorage.getItem('luckyDraw_sheetUrl');
            if (savedUrl) {
                document.getElementById('sheet-url').value = savedUrl;
                loadFromUrl(savedUrl);
            } else {
                useSampleData();
                toggleModal();
            }
        };

        function toggleModal() {
            const body = document.querySelector('body');
            const modal = document.querySelector('.modal');
            const content = document.getElementById('modal-content');

            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            body.classList.toggle('modal-active');

            if (!modal.classList.contains('opacity-0')) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            } else {
                content.classList.add('scale-95');
                content.classList.remove('scale-100');
            }
        }

        function useSampleData() {
            setEmployeesData(sampleEmployees);
            toggleModal();
            document.getElementById('error-msg').classList.add('hidden');
        }

        async function saveAndLoadSheet() {
            const url = document.getElementById('sheet-url').value.trim();
            if (!url) {
                showError("Vui l√≤ng nh·∫≠p ƒë∆∞·ªùng link!");
                return;
            }
            document.getElementById('loading-msg').classList.remove('hidden');
            document.getElementById('error-msg').classList.add('hidden');
            const success = await loadFromUrl(url);
            document.getElementById('loading-msg').classList.add('hidden');
            if (success) {
                localStorage.setItem('luckyDraw_sheetUrl', url);
                toggleModal();
            }
        }

        async function loadFromUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c");
                const csvText = await response.text();
                const data = parseCSV(csvText);
                if (data.length === 0) throw new Error("File tr·ªëng ho·∫∑c sai");
                setEmployeesData(data);
                return true;
            } catch (error) {
                showError("L·ªói: " + error.message);
                return false;
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) return [];
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',');
                if (cols.length >= 2) {
                    const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : '';
                    result.push({
                        id: clean(cols[0]),
                        name: clean(cols[1]),
                        dept: clean(cols[2]) || "",
                        title: clean(cols[3]) || ""
                    });
                }
            }
            return result;
        }

        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.innerText = msg;
            el.classList.remove('hidden');
        }

        function setEmployeesData(data) {
            originalEmployees = [...data];
            employees = [...data];
            updateCount();
            resetVisuals();
        }

        function updateCount() {
            document.getElementById('count-remaining').innerText = employees.length;
        }

        function resetData() {
            if (isSpinning) return;
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset l·∫°i danh s√°ch kh√¥ng?')) {
                employees = [...originalEmployees];
                document.getElementById('winners-list').innerHTML = `
                <div class="text-gray-500 text-center italic mt-20 flex flex-col items-center opacity-50">
                    <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>Ch∆∞a c√≥ ai tr√∫ng th∆∞·ªüng</span>
                </div>`;
                resetVisuals();
                updateCount();
            }
        }

        function resetVisuals() {
            const box = document.getElementById('slot-box');
            box.classList.remove('winner-glow', 'border-yellow-400');
            box.classList.add('border-gray-700');

            const dCode = document.getElementById('display-code');
            dCode.innerText = "-----";
            dCode.classList.remove('text-yellow-400', 'scale-110');
            dCode.classList.add('text-white');

            document.getElementById('display-name').style.opacity = '0';
            document.getElementById('display-dept').style.opacity = '0';
        }

        function startSpin() {
            if (isSpinning) return;
            if (employees.length === 0) {
                alert("ƒê√£ h·∫øt nh√¢n vi√™n ho·∫∑c ch∆∞a t·∫£i danh s√°ch!");
                return;
            }

            // Init Audio Context on first interaction
            AudioEngine.init();

            isSpinning = true;
            const btn = document.getElementById('btn-spin');
            btn.disabled = true;
            btn.innerText = "ƒêANG QUAY...";

            resetVisuals();

            // Hi·ªáu ·ª©ng ch·∫°y s·ªë nhanh
            let speed = 50;

            spinInterval = setInterval(() => {
                const randomEmp = employees[Math.floor(Math.random() * employees.length)];
                document.getElementById('display-code').innerText = randomEmp.id;

                // PLAY SOUND ON TICK
                AudioEngine.playTick();

            }, speed);

            setTimeout(() => {
                clearInterval(spinInterval);
                slowDown(70); // B·∫Øt ƒë·∫ßu l√†m ch·∫≠m t·ª´ 70ms
            }, 2000);
        }

        function slowDown(delay) {
            // Khi delay > 700ms th√¨ d·ª´ng h·∫≥n
            if (delay > 700) {
                finalizeWinner();
                return;
            }

            const randomEmp = employees[Math.floor(Math.random() * employees.length)];
            document.getElementById('display-code').innerText = randomEmp.id;

            // PLAY SOUND ON SLOW TICK
            AudioEngine.playTick();

            // G·ªçi ƒë·ªá quy v·ªõi delay tƒÉng d·∫ßn
            setTimeout(() => {
                slowDown(delay * 1.15);
            }, delay);
        }

        function finalizeWinner() {
            const winnerIndex = Math.floor(Math.random() * employees.length);
            const winner = employees[winnerIndex];

            const displayCode = document.getElementById('display-code');
            const displayName = document.getElementById('display-name');
            const displayDept = document.getElementById('display-dept');
            const box = document.getElementById('slot-box');

            displayCode.innerText = winner.id;
            displayName.innerText = winner.name;
            displayDept.innerText = winner.dept;

            displayCode.classList.remove('text-white');
            displayCode.classList.add('text-yellow-400', 'scale-110');
            displayName.style.opacity = '1';
            displayDept.style.opacity = '1';

            box.classList.remove('border-gray-700');
            box.classList.add('winner-glow', 'border-yellow-400');

            fireConfetti();
            addToHistory(winner);

            // PLAY WIN SOUND
            AudioEngine.playWin();

            employees.splice(winnerIndex, 1);
            updateCount();

            isSpinning = false;
            const btn = document.getElementById('btn-spin');
            btn.disabled = false;
            btn.innerText = "QUAY TI·∫æP";
        }

        function addToHistory(winner) {
            const list = document.getElementById('winners-list');
            // Remove empty placeholder if exists
            if (list.children[0] && list.children[0].classList.contains('text-gray-500')) {
                list.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = "bg-gray-700/60 p-4 rounded-xl border-l-4 border-yellow-400 flex justify-between items-center animate-fade-in-down shadow-sm hover:bg-gray-700 transition-colors";
            item.innerHTML = `
                <div class="overflow-hidden">
                    <div class="font-bold text-white truncate text-lg">${winner.name}</div>
                    <div class="text-xs text-gray-400 truncate tracking-wider">${winner.dept}</div>
                </div>
                <div class="text-yellow-400 font-mono font-black text-xl ml-4 bg-gray-800 px-3 py-1 rounded-lg">${winner.id}</div>
            `;
            list.insertBefore(item, list.firstChild);
        }

        // --- CONFETTI ---
        const canvas = document.getElementById("confetti-canvas");
        const ctx = canvas.getContext("2d");
        let confettiParticles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function fireConfetti() {
            confettiParticles = [];
            const colors = ['#fde047', '#ef4444', '#3b82f6', '#10b981', '#f472b6'];
            for (let i = 0; i < 350; i++) {
                confettiParticles.push({
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 5 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    vx: (Math.random() - 0.5) * 100,
                    vy: (Math.random() - 0.5) * 100 - 5,
                    grav: 0.25,
                    drag: 0.96
                });
            }
            requestAnimationFrame(updateConfetti);
        }

        function updateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            confettiParticles.forEach((p, index) => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.grav;
                p.vx *= p.drag;
                p.vy *= p.drag;

                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                if (p.y > canvas.height || p.vx < 0.1 && p.vx > -0.1) confettiParticles.splice(index, 1);
            });
            if (confettiParticles.length > 0) requestAnimationFrame(updateConfetti);
        }

        function hideControlView() {
            document.querySelectorAll(".control-view").forEach(element => {
                element.style.display = "none";
                document.getElementById("slot-machine-main").classList.remove("col-span-2");
                document.getElementById("slot-machine-main").classList.add("col-span-3");
            });
        }

        function showControlView() {
            document.querySelectorAll(".control-view").forEach(element => {
                element.style.display = "";
                document.getElementById("slot-machine-main").classList.remove("col-span-3");
                document.getElementById("slot-machine-main").classList.add("col-span-2");
            });
        }
    </script>
</body>

</html>
